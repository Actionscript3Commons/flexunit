<?xml version="1.0" encoding="UTF-8"?>

<!-- 
Since we're eating our own dogfood here, our build process is a bit non-standard.  Assuming
the following call should be made to run this script: 

	ant -v clean package
	
the build order is as such:

	clean->init->anttasks->library->cilistener->test->uirunner->report->package
	
Reporting is something each project implements which we then have hooked into Hudson
to contribute to our CI process.
-->
<project name="FlexUnit4" basedir="." default="package">
	<property environment="env" />

	<!-- Configuration -->
	<property name="build.number" value="4.0.0" />
	<property name="build.useFlex" value="true" />
	<property name="build.artifact.name" value="flexunit-${build.number}.zip" />

	<!-- Project locations -->
	<property name="anttasks.loc" location="${basedir}/FlexUnit4AntTasks" />
	<property name="core.loc" location="${basedir}/FlexUnit4" />
	<property name="cilistener.loc" location="${basedir}/FlexUnit4CIListener" />
	<property name="tests.loc" location="${basedir}/FlexUnit4Test" />
	<property name="uirunner.loc" location="${basedir}/FlexUnit4UIRunner" />

	<!-- Cleans up all projects -->
	<target name="clean">
		<ant dir="${anttasks.loc}" target="clean" inheritall="false" />
		<ant dir="${core.loc}" target="clean" inheritall="false" />
		<ant dir="${cilistener.loc}" target="clean" inheritall="false" />
		<ant dir="${tests.loc}" target="clean" inheritall="false" />
		<ant dir="${uirunner.loc}" target="clean" inheritall="false" />
		<delete file="${basedir}/${build.artifact.name}" />
	</target>

	<!-- Builds the FlexUnit4AntTasks project -->
	<target name="anttasks">
		<ant dir="${anttasks.loc}" target="package" inheritall="false">
			<property name="build.number" value="${build.number}" />
		</ant>
	</target>

	<!-- Builds the core FlexUnit4 project -->
	<target name="core">
		<ant dir="${core.loc}" target="package" inheritall="false">
			<property name="build.number" value="${build.number}" />
			<property name="build.useFlex" value="${build.useFlex}" />
		</ant>
	</target>

	<!-- Prepares and builds the FlexUnit4CIListener project -->
	<target name="cilistener" depends="core">
		<copy todir="${cilistener.loc}/libs" overwrite="true">
			<fileset dir="${core.loc}/target">
				<include name="*.swc" />
			</fileset>
		</copy>

		<ant dir="${cilistener.loc}" target="package" inheritall="false">
			<property name="build.number" value="${build.number}" />
			<property name="build.useFlex" value="${build.useFlex}" />
		</ant>
	</target>

	<!-- Prepares and builds the FlexUnit4Test project -->
	<target name="test" depends="anttasks,core,cilistener">
		<copy todir="${tests.loc}/libs" overwrite="true">
			<fileset dir="${anttasks.loc}/target">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${core.loc}/target">
				<include name="*.swc" />
			</fileset>
			<fileset dir="${cilistener.loc}/target">
				<include name="*.swc" />
			</fileset>
		</copy>

		<ant dir="${tests.loc}" target="test" inheritall="false">
			<property name="build.number" value="${build.number}" />
			<property name="build.useFlex" value="${build.useFlex}" />
		</ant>
	</target>

	<!-- Prepares and builds the FlexUnit4UIRunner project -->
	<target name="uirunner" depends="test">
		<copy todir="${uirunner.loc}/libs" overwrite="true">
			<fileset dir="${core.loc}/target">
				<include name="*.swc" />
			</fileset>
		</copy>

		<ant dir="${uirunner.loc}" target="package" inheritall="false">
			<property name="build.number" value="${build.number}" />
			<property name="build.useFlex" value="${build.useFlex}" />
		</ant>
	</target>
	
	<!-- Generates CI reporting and documentation for all projects -->
	<target name="report" depends="uirunner">
		<ant dir="${anttasks.loc}" target="report" inheritall="false">
			<property name="build.number" value="${build.number}" />
		</ant>
		<ant dir="${core.loc}" target="report" inheritall="false">
			<property name="build.number" value="${build.number}" />
			<property name="build.useFlex" value="${build.useFlex}" />
		</ant>
		<ant dir="${cilistener.loc}" target="report" inheritall="false">
			<property name="build.number" value="${build.number}" />
			<property name="build.useFlex" value="${build.useFlex}" />
		</ant>
		<ant dir="${uirunner.loc}" target="report" inheritall="false">
			<property name="build.number" value="${build.number}" />
			<property name="build.useFlex" value="${build.useFlex}" />
		</ant>
	</target>

	<!-- Prepares and assembles the final zip artifact with all of the FlexUnit4 components and docs -->
	<target name="package" depends="report">
		<zip destfile="${basedir}/${build.artifact.name}">
			<zipfileset dir="${anttasks.loc}/target/docs" prefix="flexunit/docs/anttasks" />
			<zipfileset dir="${core.loc}/target/docs" prefix="flexunit/docs/flexunit" />
			<zipfileset dir="${cilistener.loc}/target/docs" prefix="flexunit/docs/cilistener" />
			<zipfileset dir="${uirunner.loc}/target/docs" prefix="flexunit/docs/uirunner" />

			<zipfileset dir="${anttasks.loc}/target" prefix="flexunit">
				<include name="*.jar" />
			</zipfileset>
			<zipfileset dir="${core.loc}/target" prefix="flexunit">
				<include name="*.swc" />
			</zipfileset>
			<zipfileset dir="${cilistener.loc}/target" prefix="flexunit">
				<include name="*.swc" />
			</zipfileset>
			<zipfileset dir="${uirunner.loc}/target" prefix="flexunit">
				<include name="*.swc" />
			</zipfileset>
		</zip>
	</target>
</project>
